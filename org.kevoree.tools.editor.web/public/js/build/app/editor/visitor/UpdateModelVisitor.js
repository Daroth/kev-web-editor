define(["kevoree","abstraction/KGroup","abstraction/KInputPort","abstraction/KOutputPort"],function(e,t,n,r){function i(){this._factory=new e.org.kevoree.impl.DefaultKevoreeFactory,this._listener=function(){}}function s(e){if(typeof e.getUI=="function"&&e.getUI()&&e.getUI().getShape()){var t=e.getUI().getShape().getAbsolutePosition();e._instance.setMetaData("x="+parseInt(t.x)+",y="+parseInt(t.y))}}return i.prototype.setModel=function(e){this._model=e},i.prototype.setListener=function(e){if(!e||typeof e!="function")throw"UpdateModelVisitor setListener's callback is not a function.";this._listener=e},i.prototype.visitChannel=function(e){e._instance=e._instance||this._factory.createChannel(),e._instance.setName(e._name),e._instance.setTypeDefinition(this._model.findTypeDefinitionsByID(e._type)),s(e),e.getDictionary().accept(this),this._model.addHubs(e._instance),this._listener.call(this)},i.prototype.visitNode=function(e){e._instance=e._instance||this._factory.createContainerNode(),e._props._instance=e._instance,e._instance.setName(e._name),e._instance.setTypeDefinition(this._model.findTypeDefinitionsByID(e._type)),s(e),e.getDictionary().accept(this),this._model.addNodes(e._instance);if(e._parent){var t=this._model.findNodesByID(e._parent.getName());t.addHosts(e._instance)}if(e._children.length>0)for(var n=0;n<e._children.length;n++)e._children[n].accept(this);if(e._wires.length>0)for(var n=0;n<e._wires.length;n++)e._wires[n].getOrigin().accept(this);this._listener.call(this)},i.prototype.visitComponent=function(e){e._instance=e._instance||this._factory.createComponentInstance(),e._instance.setName(e._name),e._instance.setTypeDefinition(this._model.findTypeDefinitionsByID(e._type)),s(e),e.getDictionary().accept(this);var t=this._model.findNodesByID(e._parent.getName());t.addComponents(e._instance);for(var n=0;n<e._inputs.length;n++)e._inputs[n].accept(this);for(var n=0;n<e._outputs.length;n++)e._outputs[n].accept(this);for(var n=0;n<e._wires.length;n++)e._wires[n].accept(this);this._listener.call(this)},i.prototype.visitGroup=function(e){e._instance=e._instance||this._factory.createGroup(),e._instance.setName(e._name),e._instance.setTypeDefinition(this._model.findTypeDefinitionsByID(e._type)),s(e),e.getDictionary().accept(this);if(e._wires.length>0)for(var t=0;t<e._wires.length;t++)e._wires[t].accept(this);this._model.addGroups(e._instance),this._listener.call(this)},i.prototype.visitWire=function(e){switch(e.getOrigin().getEntityType()){case t.ENTITY_TYPE:var i=this._model.findNodesByID(e.getTarget().getName()),s=this._model.findGroupsByID(e.getOrigin().getName());i&&s&&s.addSubNodes(i);break;case n.ENTITY_TYPE:case r.ENTITY_TYPE:var o=this._model.findHubsByID(e.getTarget().getName()),u=e._instance?!0:!1;e._instance=e._instance||this._factory.createMBinding(),e._instance.setPort(e.getOrigin()._instance),e._instance.setHub(o),u||this._model.addMBindings(e._instance)}this._listener.call(this)},i.prototype.visitOutputPort=function(e){var t=this._model.findNodesByID(e._component.getParent().getName()),n=t.findComponentsByID(e._component.getName()),r=n.getTypeDefinition().findRequiredByID(e.getName()),i=e._instance?!0:!1;e._instance=e._instance||this._factory.createPort(),i||n.addRequired(e._instance),e._instance.setPortTypeRef(r),this._listener.call(this)},i.prototype.visitInputPort=function(e){var t=this._model.findNodesByID(e._component.getParent().getName()),n=t.findComponentsByID(e._component.getName()),r=n.getTypeDefinition().findProvidedByID(e.getName()),i=e._instance?!0:!1;e._instance=e._instance||this._factory.createPort(),i||n.addProvided(e._instance),e._instance.setPortTypeRef(r),this._listener.call(this)},i.prototype.visitNodeProperties=function(e){var t=e.getNodeNetworks();for(var n=0;n<t.length;n++)t[n].accept(this)},i.prototype.visitNodeNetwork=function(e){var t=this._model.findNodesByID(e._target.getName()),n=this._model.findNodesByID(e._initBy.getName());e._instance&&this._model.removeNodeNetworks(e._instance),e._instance=this._factory.createNodeNetwork(),e._instance.setTarget(t),e._instance.setInitBy(n);var r=e.getTarget().getNodeProperties().getLinks();for(var i in r){var s=this._factory.createNodeLink();s.setNetworkType(r[i].getNetworkType()),s.setEstimatedRate(r[i].getEstimatedRate());var o=r[i].getNetworkProperties();for(var u in o)if(o[u].getKey()!=null&&o[u].getValue()!=null){var a=this._factory.createNetworkProperty();a.setName(o[u].getKey()),a.setValue(o[u].getValue()),s.addNetworkProperties(a)}e._instance.addLink(s)}this._model.addNodeNetworks(e._instance),this._listener.call(this)},i.prototype.visitNodeLink=function(e){e.getNodeProperties().accept(this)},i.prototype.visitNetworkProperty=function(e){e.getLink().getNodeProperties().accept(this)},i.prototype.visitDictionary=function(e){e._instance=e._instance||this._factory.createDictionary(),e._instance.removeAllValues();for(var t=0;t<e.getValues().length;t++)e.getValues()[t].accept(this);e.getEntity()._instance.setDictionary(e._instance),this._listener.call(this)},i.prototype.visitValue=function(e){if(e.getValue()!=null){var t=e.getAttribute().getDictionary().getEntity().getType(),n=this._model.findTypeDefinitionsByID(t).getDictionaryType(),r=this._factory.createDictionaryValue();r.setAttribute(n.findAttributesByID(e.getAttribute().getName())),r.setValue(e.getValue());var i=null;e.getAttribute().getFragmentDependant()==1&&(i=this._model.findNodesByID(e.getTargetNode().getName())),r.setTargetNode(i),e.getAttribute().getDictionary()._instance.addValues(r),e._instance=r,this._listener.call(this)}},i});